# =============================================================================
# EDGE26 CONFIGURATION
# =============================================================================
# Edit this file, then run: python main.py --config config/settings.yaml
# All paths are relative to edge26/ directory unless absolute

# =============================================================================
# DEVICE
# =============================================================================
# Two device types work together:
#   FLICK  - Full pipeline (detect + classify). Also classifies DOT data.
#   DOT    - Detection only. Sends crops/composites to a FLICK for classification.
# DOTs send directories to the same input_storage path. The FLICK identifies
# them by matching directory names against dot_ids.
device:
  flick_id: "flick01"                 # This FLICK's identifier (used in filenames + output)
  dot_ids: ["dot01", "dot02"]         # Known DOT devices that send data to this FLICK

# =============================================================================
# PIPELINE MODE
# =============================================================================
pipeline:
  enable_recording: true              # Enable continuous video recording
  enable_processing: true             # Enable detection/tracking/classification
  enable_classification: true         # Enable Hailo classification (false = detection only, N/A predictions)
  continuous_tracking: true           # true = tracks persist across video chunks, false = reset each video
  recording_mode: "continuous"        # "continuous" = no gaps, "interval" = record every N minutes
  recording_interval_minutes: 5       # Minutes between recordings (only used in interval mode)
  # Modes:
  #   Both true   = Record + process asynchronously (default)
  #   Recording   = Only record videos (no recording)
  #   Processing  = Only process existing videos (no recording)
  #   Classification off = Detection/tracking only, output has N/A predictions
  # Recording modes:
  #   continuous = Record non-stop, chunk after chunk with no gaps
  #   interval   = Record one chunk, wait recording_interval_minutes, repeat
  # Tracking modes:
  #   continuous_tracking true  = Tracker persists across chunks (tracks can span videos)
  #   continuous_tracking false = Full reset between videos (each video is independent)

# =============================================================================
# PATHS
# =============================================================================
paths:
  input_storage: "/mnt/usb/videos"    # Input directory (FLICK videos + DOT directories)
  logs_dir: "output/logs"             # Log files directory

# =============================================================================
# CAPTURE
# =============================================================================
capture:
  camera_index: 0                     # Camera device index
  use_picamera: true                  # true=Raspberry Pi, false=USB camera
  fps: 30                             # Frames per second
  chunk_duration_seconds: 60          # Video chunk length (1 minute)

# =============================================================================
# DETECTION (Motion-based)
# =============================================================================
detection:
  # GMM Background Subtractor
  gmm_history: 500
  gmm_var_threshold: 16
  
  # Morphological filtering
  morph_kernel_size: 3                # Noise removal kernel size (NxN)
  
  # Shape filters
  min_area: 200                       # Min contour area (px²)
  max_area: 40000                     # Max contour area (px²)
  min_density: 3.0                    # Min area/perimeter ratio
  min_solidity: 0.55                  # Min convex hull fill ratio
  
  # Cohesiveness (distinguishes insects from plant motion)
  min_largest_blob_ratio: 0.80        # Min ratio of largest blob to total
  max_num_blobs: 5                    # Max blobs in detection region
  min_motion_ratio: 0.15              # Min motion pixels / bbox area
  
  # Track consistency
  max_frame_jump: 100                 # Max pixels between frames
  max_area_change_ratio: 3.0          # Max area change between frames
  
  # Path topology (for confirming insects)
  min_path_points: 10                 # Min points for topology analysis
  min_displacement: 50                # Min net displacement (px)
  max_revisit_ratio: 0.30             # Max revisit ratio (plant = high)
  min_progression_ratio: 0.70         # Min forward progression (plant = low)
  max_directional_variance: 0.90      # Max heading variance (plant = high)
  revisit_radius: 50                  # Radius (px) for revisit detection

# =============================================================================
# CLASSIFICATION (Hailo - Family/Genus/Species)
# =============================================================================
classification:
  model: "data/models/classifier.hef" # Path to HEF model
  labels: "data/models/labels.txt"    # Species list (one per line, same order as training)
  normalize: false                    # true=ImageNet normalization, false=uint8
  # input_size: [64, 64]              # Override model input size [H, W]

# =============================================================================
# TRACKING (Hungarian algorithm)
# =============================================================================
tracking:
  w_dist: 0.6                         # Distance weight in cost function
  w_area: 0.4                         # Area weight in cost function
  cost_threshold: 0.3                 # Max cost for valid match
  max_lost_frames: 45                 # Frames before track deleted (~1.5s @30fps)

# =============================================================================
# OUTPUT
# =============================================================================
# Output structure: results_dir/{device_id}/{date_time}/
#   crops/        - Crop images per track
#   composites/   - Composite images per track
#   results.json  - Classification results
output:
  results_dir: "output/results"       # Root results directory
  save_crops: true                    # Save crop images per detection
  save_composites: true               # Save composite images per track
